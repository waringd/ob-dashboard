<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OB Setup Dashboard ‚Äî Trade History</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
  :root {
    --bg-primary:#0a0e17;--bg-secondary:#111827;--bg-card:#151d2e;--bg-hover:#1c2640;
    --border:#1e293b;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;
    --accent-blue:#3b82f6;--accent-green:#10b981;--accent-red:#ef4444;--accent-amber:#f59e0b;--accent-purple:#8b5cf6;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Outfit',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border);height:48px;position:sticky;top:0;z-index:100}
  .topbar-left{display:flex;align-items:center;gap:16px}
  .logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:14px;color:var(--accent-blue)}
  .logo span{color:var(--text-muted);font-weight:400}
  .nav-link{font-size:12px;color:var(--text-secondary);text-decoration:none;padding:4px 10px;border-radius:4px;transition:all .15s}
  .nav-link:hover,.nav-link.active{color:var(--text-primary);background:var(--bg-hover)}
  .nav-link.active{color:var(--accent-blue)}
  .topbar-right{display:flex;align-items:center;gap:12px}
  .status-dot{width:7px;height:7px;border-radius:50%;background:var(--accent-green);animation:pulse 2s infinite}
  .status-dot.offline{background:var(--accent-red);animation:none}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .status-text{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-muted)}

  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:16px 20px}
  .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
  .stat-label{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);margin-bottom:4px}
  .stat-value{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700}
  .stat-value.green{color:var(--accent-green)}.stat-value.red{color:var(--accent-red)}
  .stat-value.blue{color:var(--accent-blue)}.stat-value.amber{color:var(--accent-amber)}
  .stat-value.purple{color:var(--accent-purple)}

  .filters-bar{display:flex;align-items:center;gap:12px;padding:0 20px 12px;flex-wrap:wrap}
  .filter-group{display:flex;align-items:center;gap:4px}
  .filter-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-right:4px}
  .fbtn{padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;font-size:10px;border-radius:4px;cursor:pointer;transition:all .15s}
  .fbtn:hover{border-color:var(--text-muted);color:var(--text-primary)}
  .fbtn.active{background:var(--accent-blue);border-color:var(--accent-blue);color:white}
  .filter-select{padding:4px 8px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:11px;border-radius:4px}

  .table-container{padding:0 20px 20px;overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{
    background:var(--bg-secondary);padding:10px 12px;text-align:left;
    font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);
    border-bottom:2px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap;transition:color .15s;
  }
  thead th:hover{color:var(--text-primary)}
  thead th.sorted{color:var(--accent-blue)}
  thead th .arrow{font-size:9px;margin-left:3px}
  tbody tr.trade-row{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer}
  tbody tr.trade-row:hover{background:var(--bg-hover)}
  tbody tr.trade-row.selected{background:var(--bg-card)}
  tbody td{padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:11px;white-space:nowrap}
  .td-symbol{font-weight:600;color:var(--text-primary)}
  .td-long{color:var(--accent-green);font-weight:600}
  .td-short{color:var(--accent-red);font-weight:600}
  .td-active{color:var(--accent-blue)}
  .td-tp{color:var(--accent-green)}
  .td-sl{color:var(--accent-red)}
  .td-rr{color:var(--accent-amber)}
  .td-muted{color:var(--text-muted)}

  /* Expanded detail row */
  tr.detail-row{display:none}
  tr.detail-row.visible{display:table-row}
  tr.detail-row td{padding:0}
  .detail-card{
    background:var(--bg-card);border:1px solid var(--border);border-radius:8px;
    margin:4px 12px 12px;padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;
  }
  .dc-item{display:flex;flex-direction:column;gap:2px}
  .dc-label{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
  .dc-value{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:500}
  .dc-value.blue{color:var(--accent-blue)}.dc-value.red{color:var(--accent-red)}
  .dc-value.green{color:var(--accent-green)}.dc-value.amber{color:var(--accent-amber)}

  .empty-state{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:14px}
  .empty-state .icon{font-size:40px;margin-bottom:12px;opacity:.3}

  .breakdown-section{padding:0 20px 20px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .breakdown-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px}
  .breakdown-title{font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:12px}
  .breakdown-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px}
  .breakdown-row:last-child{border-bottom:none}
  .bar-container{flex:1;margin:0 12px;height:4px;background:var(--bg-primary);border-radius:2px;overflow:hidden}
  .bar-fill{height:100%;border-radius:2px;transition:width .3s}
  @media(max-width:800px){.breakdown-section{grid-template-columns:1fr}.stats-row{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:768px){
    .topbar{padding:6px 10px;min-height:40px}
    .topbar-left{gap:6px}
    .logo{font-size:12px}
    .nav-link{font-size:10px;padding:3px 6px}
    .status-text{display:none}
    .stats-row{grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 12px}
    .stat-card{padding:10px 6px}
    .stat-label{font-size:8px}
    .stat-value{font-size:18px}
    .filters-bar{padding:0 12px 10px;gap:8px}
    .filter-group{gap:3px}
    .filter-label{font-size:9px;margin-right:2px}
    .fbtn{padding:4px 7px;font-size:9px}
    .filter-select{font-size:10px;padding:4px 6px}
    .table-container{padding:0 8px 16px}
    thead th{padding:8px 6px;font-size:9px}
    tbody td{padding:8px 6px;font-size:10px}
    .detail-card{grid-template-columns:repeat(2,1fr);gap:8px;margin:4px 4px 8px;padding:12px}
    .dc-label{font-size:8px}
    .dc-value{font-size:11px}
    .breakdown-section{padding:0 12px 16px;gap:10px}
    .breakdown-card{padding:12px}
    .breakdown-title{font-size:11px}
    .breakdown-row{font-size:10px}
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo">OB<span>DASH</span></div>
    <a href="ob-dashboard.html" class="nav-link">Live Chart</a>
    <a href="ob-history.html" class="nav-link active">Trade History</a>
  </div>
  <div class="topbar-right">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusText">Loading...</span>
  </div>
</div>

<div class="stats-row">
  <div class="stat-card"><div class="stat-label">Total Trades</div><div class="stat-value blue" id="statTotal">‚Äî</div></div>
  <div class="stat-card"><div class="stat-label">Active</div><div class="stat-value purple" id="statActive">‚Äî</div></div>
  <div class="stat-card"><div class="stat-label">Wins</div><div class="stat-value green" id="statWins">‚Äî</div></div>
  <div class="stat-card"><div class="stat-label">Losses</div><div class="stat-value red" id="statLosses">‚Äî</div></div>
  <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value green" id="statWR">‚Äî</div></div>
  <div class="stat-card"><div class="stat-label">Avg RR</div><div class="stat-value amber" id="statRR">‚Äî</div></div>
</div>

<div class="filters-bar">
  <div class="filter-group">
    <span class="filter-label">Status</span>
    <button class="fbtn active" data-f="status" data-v="all" onclick="tog(this)">All</button>
    <button class="fbtn" data-f="status" data-v="active" onclick="tog(this)">Active</button>
    <button class="fbtn" data-f="status" data-v="closed" onclick="tog(this)">Closed</button>
    <button class="fbtn" data-f="status" data-v="tp" onclick="tog(this)">TP</button>
    <button class="fbtn" data-f="status" data-v="sl" onclick="tog(this)">SL</button>
  </div>
  <div class="filter-group">
    <span class="filter-label">Timeframe</span>
    <button class="fbtn active" data-f="tf" data-v="all" onclick="tog(this)">All</button>
    <button class="fbtn" data-f="tf" data-v="H1" onclick="tog(this)">H1</button>
    <button class="fbtn" data-f="tf" data-v="M15" onclick="tog(this)">M15</button>
  </div>
  <div class="filter-group">
    <span class="filter-label">Source</span>
    <button class="fbtn active" data-f="source" data-v="all" onclick="tog(this)">All</button>
    <button class="fbtn" data-f="source" data-v="v3" onclick="tog(this)">V3</button>
    <button class="fbtn" data-f="source" data-v="modelb" onclick="tog(this)">Model B</button>
  </div>
  <div class="filter-group">
    <span class="filter-label">Pair</span>
    <select class="filter-select" id="pairFilter" onchange="apply()"><option value="all">All Pairs</option></select>
  </div>
</div>

<div class="table-container">
  <table>
    <thead><tr>
      <th data-col="symbol" onclick="sortBy('symbol')">Pair <span class="arrow"></span></th>
      <th data-col="direction" onclick="sortBy('direction')">Dir <span class="arrow"></span></th>
      <th data-col="timeframe" onclick="sortBy('timeframe')">TF <span class="arrow"></span></th>
      <th data-col="source" onclick="sortBy('source')">Source <span class="arrow"></span></th>
      <th data-col="entry" onclick="sortBy('entry')">Entry <span class="arrow"></span></th>
      <th data-col="rr" onclick="sortBy('rr')">RR <span class="arrow"></span></th>
      <th data-col="status" onclick="sortBy('status')">Outcome <span class="arrow"></span></th>
      <th data-col="time" onclick="sortBy('time')">Opened <span class="arrow"></span></th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="breakdown-section" id="breakdowns">
  <div class="breakdown-card" id="pairBD"><div class="breakdown-title">Win Rate by Pair</div></div>
  <div class="breakdown-card" id="srcBD"><div class="breakdown-title">Win Rate by Source</div></div>
</div>

<script>
const DEFAULTS={apiUrl:'https://ob-setup-api.onrender.com',apiKey:'Xd8xhdyxjQqq'};
function loadCfg(){try{return{...DEFAULTS,...JSON.parse(localStorage.getItem('obdash_config')||'{}')}}catch{return{...DEFAULTS}}}
const config=loadCfg();
let allTrades=[],filtered=[],sortCol='time',sortDir='desc';
let filters={status:'all',tf:'all',source:'all',pair:'all'};
let expandedTicket=null;

async function fetchHistory(){
  try{
    const r=await fetch(`${config.apiUrl}/history`,{headers:{'X-API-Key':config.apiKey}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    allTrades=d.trades||[];
    updateStats(d.stats||{});
    populatePairs(); apply();
    setStatus(true,`${allTrades.length} trades loaded`);
  }catch(e){console.error(e);setStatus(false,'API error');showEmpty();}
}
function setStatus(on,t){
  document.getElementById('statusDot').className='status-dot'+(on?'':' offline');
  document.getElementById('statusText').textContent=t;
}
function updateStats(s){
  document.getElementById('statTotal').textContent=s.total_trades||0;
  document.getElementById('statActive').textContent=s.active||0;
  document.getElementById('statWins').textContent=s.wins||0;
  document.getElementById('statLosses').textContent=s.losses||0;
  document.getElementById('statWR').textContent=s.closed>0?s.win_rate+'%':'‚Äî';
  document.getElementById('statRR').textContent=s.avg_rr?s.avg_rr+':1':'‚Äî';
}
function populatePairs(){
  const sel=document.getElementById('pairFilter');
  const pairs=[...new Set(allTrades.map(t=>t.symbol))].sort();
  sel.innerHTML='<option value="all">All Pairs</option>'+pairs.map(p=>`<option value="${p}">${p}</option>`).join('');
}
function tog(btn){
  const g=btn.dataset.f;
  document.querySelectorAll(`.fbtn[data-f="${g}"]`).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  filters[g]=btn.dataset.v; apply();
}
function apply(){
  filters.pair=document.getElementById('pairFilter').value;
  filtered=allTrades.filter(t=>{
    if(filters.status!=='all'){
      if(filters.status==='active'&&t.status!=='active') return false;
      if(filters.status==='closed'&&!t.status.startsWith('closed')) return false;
      if(filters.status==='tp'&&t.status!=='closed_tp') return false;
      if(filters.status==='sl'&&t.status!=='closed_sl') return false;
    }
    if(filters.tf!=='all'&&t.timeframe!==filters.tf) return false;
    if(filters.source!=='all'&&t.source!==filters.source) return false;
    if(filters.pair!=='all'&&t.symbol!==filters.pair) return false;
    return true;
  });
  doSort(); render(); renderBD();
}
function sortBy(col){
  if(sortCol===col) sortDir=sortDir==='asc'?'desc':'asc';
  else{sortCol=col;sortDir=col==='time'?'desc':'asc';}
  document.querySelectorAll('thead th').forEach(th=>{th.classList.remove('sorted');th.querySelector('.arrow').textContent=''});
  const th=document.querySelector(`th[data-col="${col}"]`);
  if(th){th.classList.add('sorted');th.querySelector('.arrow').textContent=sortDir==='asc'?'‚ñ≤':'‚ñº';}
  doSort(); render();
}
function doSort(){
  filtered.sort((a,b)=>{
    let va=a[sortCol],vb=b[sortCol];
    if(sortCol==='time'){va=a.time_unix||0;vb=b.time_unix||0;}
    if(typeof va==='number'&&typeof vb==='number') return sortDir==='asc'?va-vb:vb-va;
    return sortDir==='asc'?String(va||'').localeCompare(String(vb||'')):String(vb||'').localeCompare(String(va||''));
  });
}
function toggleDetail(ticket,sym){
  expandedTicket=(expandedTicket===ticket+sym)?null:ticket+sym;
  render();
}
function render(){
  const tb=document.getElementById('tbody');
  if(!filtered.length){showEmpty();return;}
  let html='';
  for(const t of filtered){
    const p=(t.symbol||'').includes('JPY')?3:5;
    const dc=t.direction==='LONG'?'td-long':'td-short';
    let sc='td-active',sl='‚óè Active';
    if(t.status==='closed_tp'){sc='td-tp';sl='‚úì TP';}
    else if(t.status==='closed_sl'){sc='td-sl';sl='‚úó SL';}
    const key=t.ticket+t.symbol;
    const isExp=expandedTicket===key;

    html+=`<tr class="trade-row${isExp?' selected':''}" onclick="toggleDetail(${t.ticket},'${t.symbol}')">
      <td class="td-symbol">${t.symbol}</td>
      <td class="${dc}">${t.direction}</td>
      <td>${t.timeframe}</td>
      <td>${(t.source||'').toUpperCase()}</td>
      <td>${t.entry.toFixed(p)}</td>
      <td class="td-rr">${t.rr}:1</td>
      <td class="${sc}">${sl}</td>
      <td class="td-muted">${t.time||'‚Äî'}</td>
    </tr>`;

    // Expandable detail row
    html+=`<tr class="detail-row${isExp?' visible':''}"><td colspan="8">
      <div class="detail-card">
        <div class="dc-item"><span class="dc-label">Symbol</span><span class="dc-value">${t.symbol}</span></div>
        <div class="dc-item"><span class="dc-label">Direction</span><span class="dc-value ${t.direction==='LONG'?'green':'red'}">${t.direction}</span></div>
        <div class="dc-item"><span class="dc-label">Timeframe</span><span class="dc-value">${t.timeframe}</span></div>
        <div class="dc-item"><span class="dc-label">Source</span><span class="dc-value">${(t.source||'').toUpperCase()}</span></div>
        <div class="dc-item"><span class="dc-label">Entry</span><span class="dc-value blue">${t.entry.toFixed(p)}</span></div>
        <div class="dc-item"><span class="dc-label">Stop Loss</span><span class="dc-value red">${t.sl.toFixed(p)}</span></div>
        <div class="dc-item"><span class="dc-label">Take Profit</span><span class="dc-value green">${t.tp.toFixed(p)}</span></div>
        <div class="dc-item"><span class="dc-label">OB High</span><span class="dc-value">${t.ob_high.toFixed(p)}</span></div>
        <div class="dc-item"><span class="dc-label">OB Low</span><span class="dc-value">${t.ob_low.toFixed(p)}</span></div>
        <div class="dc-item"><span class="dc-label">Risk:Reward</span><span class="dc-value amber">${t.rr}:1</span></div>
        <div class="dc-item"><span class="dc-label">Status</span><span class="dc-value ${t.status==='active'?'blue':t.status==='closed_tp'?'green':'red'}">${t.status==='active'?'‚óè Active':t.status==='closed_tp'?'‚úì TP Hit':'‚úó SL Hit'}</span></div>
        <div class="dc-item"><span class="dc-label">Ticket</span><span class="dc-value">#${t.ticket||'‚Äî'}</span></div>
        <div class="dc-item"><span class="dc-label">Opened</span><span class="dc-value">${t.time||'‚Äî'}</span></div>
        <div class="dc-item"><span class="dc-label">Closed</span><span class="dc-value">${t.close_time||'‚Äî'}</span></div>
      </div>
    </td></tr>`;
  }
  tb.innerHTML=html;
}
function showEmpty(){
  document.getElementById('tbody').innerHTML=`<tr><td colspan="8"><div class="empty-state"><div class="icon">üì≠</div>No trades found.</div></td></tr>`;
}
function renderBD(){
  const closed=filtered.filter(t=>t.status.startsWith('closed'));
  // By pair
  const ps={};
  closed.forEach(t=>{if(!ps[t.symbol])ps[t.symbol]={w:0,n:0};ps[t.symbol].n++;if(t.status==='closed_tp')ps[t.symbol].w++;});
  const pe=Object.entries(ps).sort((a,b)=>(b[1].n?b[1].w/b[1].n:0)-(a[1].n?a[1].w/a[1].n:0));
  document.getElementById('pairBD').innerHTML='<div class="breakdown-title">Win Rate by Pair</div>'+
    (!pe.length?'<div style="color:var(--text-muted);font-size:12px">No closed trades</div>':
    pe.map(([p,s])=>{const wr=s.n?Math.round(s.w/s.n*100):0;const c=wr>=50?'var(--accent-green)':'var(--accent-red)';
    return`<div class="breakdown-row"><span style="font-family:'JetBrains Mono',monospace;min-width:70px">${p}</span>
    <div class="bar-container"><div class="bar-fill" style="width:${wr}%;background:${c}"></div></div>
    <span style="font-family:'JetBrains Mono',monospace;font-weight:500;color:${c};min-width:70px;text-align:right">${wr}% (${s.w}/${s.n})</span></div>`;}).join(''));
  // By source
  const ss={};
  closed.forEach(t=>{const k=(t.source||'?').toUpperCase();if(!ss[k])ss[k]={w:0,n:0};ss[k].n++;if(t.status==='closed_tp')ss[k].w++;});
  const se=Object.entries(ss);
  document.getElementById('srcBD').innerHTML='<div class="breakdown-title">Win Rate by Source</div>'+
    (!se.length?'<div style="color:var(--text-muted);font-size:12px">No closed trades</div>':
    se.map(([p,s])=>{const wr=s.n?Math.round(s.w/s.n*100):0;const c=wr>=50?'var(--accent-green)':'var(--accent-red)';
    return`<div class="breakdown-row"><span style="font-family:'JetBrains Mono',monospace;min-width:70px">${p}</span>
    <div class="bar-container"><div class="bar-fill" style="width:${wr}%;background:${c}"></div></div>
    <span style="font-family:'JetBrains Mono',monospace;font-weight:500;color:${c};min-width:70px;text-align:right">${wr}% (${s.w}/${s.n})</span></div>`;}).join(''));
}

fetchHistory();
setInterval(fetchHistory,60000);
</script>
</body>
</html>
